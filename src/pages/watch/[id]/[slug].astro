---
export const prerender = false;
import Layout from "~/layouts/Layout.astro";
import Table from "~/components/ui/Table.astro";
import { fetchAnimeData, fetchWatchData } from "~/utils/api";

const { id, slug } = Astro.params;
const episode = Astro.url.searchParams.get("episode") ?? null;

if (!id || !slug) {
  return Astro.redirect("/404");
}

const res = await fetchAnimeData(id, slug);
if (!res) {
  return Astro.redirect("/404");
}
const data = res;

let contentType = "Tidak Diketahui";
const countryDetail = data.results.details?.find(d => {
    return d.type === "Negara:";
});

if (countryDetail && countryDetail.data) {
    const country = countryDetail.data.toLowerCase();
    if (country.includes("jp") || country.includes("jepang")) {
        contentType = "Anime";
    } else if (country.includes("cn") || country.includes("china")) {
        contentType = "Donghua";
    } else if (country.includes("kr") || country.includes("korea")) {
        contentType = "Manhwa (Animasi Korea)";
    } else {
        contentType = "Animasi Lain";
    }
}

const episodes = data.results.episode || [];
const totalEp = episodes?.at(-1) ?? 1;
const isFinished = data.results.details && data.results.details[2]?.data?.includes("Selesai");

const currentEpisodeNumber = episode ?
    parseInt(episode) : (isFinished && episodes.length > 0 ? episodes[0] : totalEp);

let downloadLinks = [];
try {
    const watchData = await fetchWatchData(id, slug, currentEpisodeNumber);
    downloadLinks = watchData?.downloads || [];
} catch (error) {
    console.error("Gagal mengambil link download:", error);
}
---

<link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css" />
<link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css" />

<Layout title={data.results.title} description={data.results.description || data.results.title}>
  <div class="container mx-auto px-0 py-4 sm:px-4 md:py-8">
    <div class="flex flex-col gap-6">

      <div class="bg-base-300 rounded-lg shadow-xl overflow-hidden px-0 py-2 sm:p-2 md:p-4">
        <p
          id="playerInfo"
          class="aspect-video skeleton flex flex-col items-center justify-center text-center text-base-content/80 text-sm md:text-lg mb-2"
        >
          Memuat video player...
          <span class="loading loading-spinner loading-md md:loading-lg mt-2 md:mt-4"></span>
        </p>
        <div
          id="player"
          data-poster={data.results.image}
          data-storage="player-storage"
          data-autoplay="true"
          data-playsinline
          class="aspect-video hidden rounded-md"
        >
        </div>
        
        <input id="episode" type="hidden" value={currentEpisodeNumber} />

        <div class="flex justify-between items-center mx-0 mt-4 px-2 py-2 bg-base-200 rounded-lg sm:mx-2 sm:p-2">
          <button id="prevEpisode" class="btn btn-sm btn-outline btn-primary">Prev</button>
          <span id="currentEp" class="text-sm md:text-base text-base-content">Episode {currentEpisodeNumber}</span>
          <button id="nextEpisode" class="btn btn-sm btn-outline btn-primary">Next</button>
        </div>

        <div class="mt-4 md:mt-6 p-3 md:p-4 bg-base-200 rounded-lg">
          <h3 class="text-lg md:text-xl font-bold mb-3 md:mb-4 text-base-content">Daftar Episode</h3>
          <select id="episodeListSelect" class="select select-bordered select-sm md:select-md w-full bg-base-100 text-base-content">
            {episodes.length > 0 ? (
              episodes.map(ep => (
                <option value={ep} selected={ep == currentEpisodeNumber}>
                  Episode {ep}
                </option>
              ))
            ) : (
              <option value="" disabled>Tidak ada episode tersedia</option>
            )}
          </select>
        </div>
      </div>

      <div class="p-4 md:p-6 rounded-lg shadow-xl bg-base-300 w-full sm:w-auto sm:mx-0">
        <h1 class="text-xl sm:text-2xl md:text-3xl mb-4 md:mb-6 text-primary">{data.results.title}</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start mb-4 md:mb-6">
          {data.results.image && (
            <figure class="mb-4 md:mb-0 text-center w-full">
              <img
                src={data.results.image}
                alt={data.results.title}
                class="rounded-lg shadow-lg mx-auto max-h-48 sm:max-h-64 md:max-h-150 object-contain w-full"
              />
            </figure>
          )}

          <div>
            <Table data={data.results.details} />
          </div>
        </div>

        <h2 class="font-bold text-lg md:text-xl mt-4 md:mt-6 mb-2 text-base-content">Sinopsis:</h2>
        <p set:html={data.results.description || "Sinopsis tidak tersedia."} class="text-sm md:text-base text-base-content/90 leading-relaxed" />
        <p class="text-xs md:text-sm text-base-content/80 mt-1 mb-6">
            Kategori: <span class="font-semibold">{contentType}</span>
        </p>

        <div class="divider"></div>
        <h2 class="font-bold text-lg md:text-xl mb-4 text-primary flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
            Download Episode {currentEpisodeNumber}
        </h2>

        {downloadLinks.length > 0 ? (
            <div class="flex flex-col gap-3">
                {downloadLinks.map((group, index) => (
                    <div class="collapse collapse-arrow bg-base-200 border border-base-content/10 shadow-sm">
                        <input type="radio" name="download-accordion" checked={index === 0} /> 
                        <div class="collapse-title text-sm md:text-base font-bold flex items-center gap-2 text-base-content/90">
                            <span class="badge badge-sm badge-outline opacity-70">
                                {group.quality_group.split(' ')[0]} {/* Menampilkan MKV/MP4 */}
                            </span>
                            {group.quality_group.replace(/MKV|MP4/g, '').trim()}
                        </div>

                        <div class="collapse-content">
                            {/* Container Tombol: Grid responsive agar rapi di HP & PC */}
                            <div class="pt-2 flex flex-wrap gap-2">
                                {group.links.map((link) => (
                                    <a 
                                        href={link.url} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        class={`
                                            btn btn-sm 
                                            flex-1 min-w-[45%] 
                                            sm:flex-none sm:min-w-0
                                            ${link.recommended 
                                                ? 'btn-primary text-primary-content shadow-md shadow-primary/20' 
                                                : 'btn-outline border-base-content/20 text-base-content hover:bg-base-content hover:text-base-100 hover:border-transparent bg-base-100'
                                            }
                                        `}
                                    >
                                        {link.provider}
                                        {link.recommended && <span class="text-xs">★</span>}
                                    </a>
                                ))}
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        ) : (
            <div class="alert alert-warning shadow-lg text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <span>Link download belum tersedia untuk episode ini. Silahkan streaming atau cek kembali nanti.</span>
            </div>
        )}

      </div>
    </div>
  </div>
  <div 
    id="anime-metadata" 
    class="hidden"
    data-id={id}
    data-slug={slug}
    data-title={data.results.title}
    data-image={data.results.image}
    data-episode={currentEpisodeNumber}
    data-type={contentType}
  ></div>
</Layout>
<script>
  import { initWatchPlayer } from "/src/scripts/watch.js";
  function saveHistory() {
    const meta = document.getElementById("anime-metadata");
    if (!meta) return;
    const animeData = {
      id: meta.dataset.id,
      slug: meta.dataset.slug,
      title: meta.dataset.title,
      image: meta.dataset.image,
      episode: "Episode " + meta.dataset.episode,
      type: meta.dataset.type,
      timestamp: new Date().getTime(), 
      link: window.location.pathname + window.location.search
    };

    const HISTORY_KEY = "anime_history";
    const MAX_HISTORY = 50;

    try {
      let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
      history = history.filter((item) => item.id !== animeData.id);
      history.unshift(animeData);
      
      if (history.length > MAX_HISTORY) {
        history = history.slice(0, MAX_HISTORY);
      }

      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    } catch (e) {
      console.error("Gagal menyimpan history", e);
    }
  }

  document.addEventListener("astro:after-swap", () => {
    initWatchPlayer();
    saveHistory(); 
  });
  
  initWatchPlayer();
  saveHistory();

  const episodeListSelect = document.getElementById("episodeListSelect");
  if (episodeListSelect) {
    episodeListSelect.addEventListener("change", (event) => {
      const selectedEpisode = event.target.value;
      if (selectedEpisode) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set("episode", selectedEpisode);
        window.location.assign(currentUrl.toString());
      }
    });
  }
</script>
const episodes = data.results.episode || [];
const totalEp = episodes?.at(-1) ?? 1;
const isFinished = data.results.details && data.results.details[2]?.data?.includes("Selesai");

const currentEpisodeNumber = episode ?
    parseInt(episode) : (isFinished && episodes.length > 0 ? episodes[0] : totalEp);

let downloadLinks = [];
try {
    const watchData = await fetchWatchData(id, slug, currentEpisodeNumber);
    downloadLinks = watchData?.downloads || [];
} catch (error) {
    console.error("Gagal mengambil link download:", error);
}
---

<link rel="stylesheet" href="https://cdn.vidstack.io/player/theme.css" />
<link rel="stylesheet" href="https://cdn.vidstack.io/player/video.css" />

<Layout title={data.results.title} description={data.results.description || data.results.title}>
  <div class="container mx-auto px-0 py-4 sm:px-4 md:py-8">
    <div class="flex flex-col gap-6">

      <div class="bg-base-300 rounded-lg shadow-xl overflow-hidden px-0 py-2 sm:p-2 md:p-4">
        <p
          id="playerInfo"
          class="aspect-video skeleton flex flex-col items-center justify-center text-center text-base-content/80 text-sm md:text-lg mb-2"
        >
          Memuat video player...
          <span class="loading loading-spinner loading-md md:loading-lg mt-2 md:mt-4"></span>
        </p>
        <div
          id="player"
          data-poster={data.results.image}
          data-storage="player-storage"
          data-autoplay="true"
          data-playsinline
          class="aspect-video hidden rounded-md"
        >
        </div>
        
        <input id="episode" type="hidden" value={currentEpisodeNumber} />

        <div class="flex justify-between items-center mx-0 mt-4 px-2 py-2 bg-base-200 rounded-lg sm:mx-2 sm:p-2">
          <button id="prevEpisode" class="btn btn-sm btn-outline btn-primary">Prev</button>
          <span id="currentEp" class="text-sm md:text-base text-base-content">Episode {currentEpisodeNumber}</span>
          <button id="nextEpisode" class="btn btn-sm btn-outline btn-primary">Next</button>
        </div>

        <div class="mt-4 md:mt-6 p-3 md:p-4 bg-base-200 rounded-lg">
          <h3 class="text-lg md:text-xl font-bold mb-3 md:mb-4 text-base-content">Daftar Episode</h3>
          <select id="episodeListSelect" class="select select-bordered select-sm md:select-md w-full bg-base-100 text-base-content">
            {episodes.length > 0 ? (
              episodes.map(ep => (
                <option value={ep} selected={ep == currentEpisodeNumber}>
                  Episode {ep}
                </option>
              ))
            ) : (
              <option value="" disabled>Tidak ada episode tersedia</option>
            )}
          </select>
        </div>
      </div>

      <div class="p-4 md:p-6 rounded-lg shadow-xl bg-base-300 w-full sm:w-auto sm:mx-0">
        <h1 class="text-xl sm:text-2xl md:text-3xl mb-4 md:mb-6 text-primary">{data.results.title}</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start mb-4 md:mb-6">
          {data.results.image && (
            <figure class="mb-4 md:mb-0 text-center w-full">
              <img
                src={data.results.image}
                alt={data.results.title}
                class="rounded-lg shadow-lg mx-auto max-h-48 sm:max-h-64 md:max-h-150 object-contain w-full"
              />
            </figure>
          )}

          <div>
            <Table data={data.results.details} />
          </div>
        </div>

        <h2 class="font-bold text-lg md:text-xl mt-4 md:mt-6 mb-2 text-base-content">Sinopsis:</h2>
        <p set:html={data.results.description || "Sinopsis tidak tersedia."} class="text-sm md:text-base text-base-content/90 leading-relaxed" />
        <p class="text-xs md:text-sm text-base-content/80 mt-1 mb-6">
            Kategori: <span class="font-semibold">{contentType}</span>
        </p>

        <div class="divider"></div>
        <h2 class="font-bold text-lg md:text-xl mb-4 text-primary flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
            Download Episode {currentEpisodeNumber}
        </h2>

        {downloadLinks.length > 0 ? (
            <div class="flex flex-col gap-3">
                {downloadLinks.map((group, index) => (
                    <div class="collapse collapse-arrow bg-base-200 border border-base-content/10 shadow-sm">
                        <input type="radio" name="download-accordion" checked={index === 0} /> 
                        <div class="collapse-title text-sm md:text-base font-bold flex items-center gap-2 text-base-content/90">
                            <span class="badge badge-sm badge-outline opacity-70">
                                {group.quality_group.split(' ')[0]} {/* Menampilkan MKV/MP4 */}
                            </span>
                            {group.quality_group.replace(/MKV|MP4/g, '').trim()}
                        </div>

                        <div class="collapse-content">
                            {/* Container Tombol: Grid responsive agar rapi di HP & PC */}
                            <div class="pt-2 flex flex-wrap gap-2">
                                {group.links.map((link) => (
                                    <a 
                                        href={link.url} 
                                        target="_blank" 
                                        rel="noopener noreferrer"
                                        class={`
                                            btn btn-sm 
                                            flex-1 min-w-[45%] 
                                            sm:flex-none sm:min-w-0
                                            ${link.recommended 
                                                ? 'btn-primary text-primary-content shadow-md shadow-primary/20' 
                                                : 'btn-outline border-base-content/20 text-base-content hover:bg-base-content hover:text-base-100 hover:border-transparent bg-base-100'
                                            }
                                        `}
                                    >
                                        {link.provider}
                                        {link.recommended && <span class="text-xs">★</span>}
                                    </a>
                                ))}
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        ) : (
            <div class="alert alert-warning shadow-lg text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current flex-shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <span>Link download belum tersedia untuk episode ini. Silahkan streaming atau cek kembali nanti.</span>
            </div>
        )}

      </div>
    </div>
  </div>
  <div 
    id="anime-metadata" 
    class="hidden"
    data-id={id}
    data-slug={slug}
    data-title={data.results.title}
    data-image={data.results.image}
    data-episode={currentEpisodeNumber}
    data-type={contentType}
  ></div>
</Layout>
<script>
  import { initWatchPlayer } from "/src/scripts/watch.js";
  function saveHistory() {
    const meta = document.getElementById("anime-metadata");
    if (!meta) return;
    const animeData = {
      id: meta.dataset.id,
      slug: meta.dataset.slug,
      title: meta.dataset.title,
      image: meta.dataset.image,
      episode: "Episode " + meta.dataset.episode,
      type: meta.dataset.type,
      timestamp: new Date().getTime(), 
      link: window.location.pathname + window.location.search
    };

    const HISTORY_KEY = "anime_history";
    const MAX_HISTORY = 50;

    try {
      let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
      history = history.filter((item) => item.id !== animeData.id);
      history.unshift(animeData);
      
      if (history.length > MAX_HISTORY) {
        history = history.slice(0, MAX_HISTORY);
      }

      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    } catch (e) {
      console.error("Gagal menyimpan history", e);
    }
  }

  document.addEventListener("astro:after-swap", () => {
    initWatchPlayer();
    saveHistory(); 
  });
  
  initWatchPlayer();
  saveHistory();

  const episodeListSelect = document.getElementById("episodeListSelect");
  if (episodeListSelect) {
    episodeListSelect.addEventListener("change", (event) => {
      const selectedEpisode = event.target.value;
      if (selectedEpisode) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set("episode", selectedEpisode);
        window.location.assign(currentUrl.toString());
      }
    });
  }
</script>
